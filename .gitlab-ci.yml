stages:
  - build
  - deploy

.variables_template: &variables_template
  REGISTRY_URL: registry.dev.hummatech.com
  IMAGE_NAME: $REGISTRY_URL/$CI_PROJECT_PATH
  TAG: latest
  DOCKER_TLS_CERTDIR: ""

# =============================
# âœ… BUILD JOB
# =============================
build:
  stage: build
  image: docker:latest
  variables:
    <<: *variables_template
  script:
    - |
      set -e
      echo "ðŸ”¹ Preparing environment file for build..."
      echo "ðŸ”¹ Branch: $CI_COMMIT_BRANCH"

      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        ENV_FILE="$ENV_PROD"
      else
        ENV_FILE="$ENV_DEV"
      fi

      if [ -z "$ENV_FILE" ]; then
        echo "âŒ ERROR: GitLab variable ENV_DEV/ENV_PROD tidak ditemukan!"
        exit 1
      fi

      echo "$ENV_FILE" > .env
      echo "âœ… .env file generated (preview):"
      head -n 5 .env

      docker info
      apk add --no-cache curl
      curl -v https://$REGISTRY_URL/v2/
      echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $REGISTRY_URL
      docker build --network host -t $IMAGE_NAME:$TAG .
      docker push $IMAGE_NAME:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      variables:
        APP_NAME: development-getskill
        PORT: 3003
    - if: '$CI_COMMIT_BRANCH == "production"'
      variables:
        APP_NAME: prod-getskill
        PORT: 3031

# =============================
# âœ… DEPLOY JOB
# =============================
deploy_dev:
  stage: deploy
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  variables:
    <<: *variables_template
    APP_NAME: development-getskill
    PORT: 3003
    DEPLOY_DIR: /root/apps/$APP_NAME
  before_script:
    - apk add --no-cache openssh bash
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_DEV" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -p $PORT_SERVER_DEV -H $DEPLOY_SERVER_DEV >> ~/.ssh/known_hosts
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
  script:
    - |
      bash -c '

      ssh -p $PORT_SERVER_DEV $USER_DEV@$DEPLOY_SERVER_DEV "
        mkdir -p $DEPLOY_DIR/nginx &&
        echo \"$NGINX_CONF\" > $DEPLOY_DIR/nginx/default.conf &&

        mkdir -p $DEPLOY_DIR &&
        echo \"$ENV_DEV\" > $DEPLOY_DIR/.env &&
        
        docker login -u $CI_REGISTRY_DEV_USER -p $CI_REGISTRY_PASSWORD $REGISTRY_URL &&
        
        docker stop $APP_NAME || true &&
        docker rm $APP_NAME || true &&
        docker pull $IMAGE_NAME:$TAG &&
        
        docker run -d --name $APP_NAME \
          --env-file $DEPLOY_DIR/.env \
          -v $DEPLOY_DIR/nginx:/etc/nginx/conf.d \
          -p $PORT:80 \
          $IMAGE_NAME:$TAG
      "
      '
